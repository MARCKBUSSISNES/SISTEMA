<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Control de Kilometraje Vehicular</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* ... [MISMO ESTILO QUE TENÍAS, SIN CAMBIOS] ... */
  </style>
</head>
<body>
  <div class="logo-header">
    <img src="LOGO1.png" alt="Logo Marck Business">
  </div>
  <div class="container">
    <h1>Control de Kilometraje</h1>
    <div style="display:flex;gap:.6rem;justify-content:space-between;">
      <button class="excel-btn" onclick="exportToExcel()">Descargar Excel</button>
      <button class="reset-btn" onclick="resetData()">Resetear Datos</button>
    </div>
    <form id="km-form" autocomplete="off">
      <div class="row2">
        <input type="number" id="km-input" min="0" required placeholder="Kilometraje">
      </div>
      <div class="row2">
        <input type="datetime-local" id="fecha-input" required>
      </div>
      <div class="row2">
        <input type="number" id="qtz-input" min="0" step="0.01" required placeholder="Gasolina Q">
        <input type="number" id="gal-input" min="0" step="0.01" required placeholder="Gasolina Gal">
      </div>
      <div class="row2">
        <input type="file" id="imagen-input" accept="image/*">
      </div>
      <button type="submit" id="save-btn">Registrar / Guardar</button>
      <input type="hidden" id="edit-index">
    </form>
    <div>
      <strong>Historial de registros:</strong>
      <div class="history" id="history"></div>
    </div>
  </div>
  <div class="logo-float-btn" title="Descargar PDF" onclick="descargarPDF()">
    <img src="LOGO1.png" alt="Descargar PDF">
  </div>
  <footer class="footer-derechos">
    © Marck Business 2025. Todos los derechos reservados.
  </footer>
  <script>
    const form = document.getElementById('km-form');
    const kmInput = document.getElementById('km-input');
    const qtzInput = document.getElementById('qtz-input');
    const galInput = document.getElementById('gal-input');
    const fechaInput = document.getElementById('fecha-input');
    const imagenInput = document.getElementById('imagen-input');
    const historyDiv = document.getElementById('history');
    const editIndex = document.getElementById('edit-index');
    const saveBtn = document.getElementById('save-btn');
    const STORAGE_KEY = "km-history-v2";
    let kmHistory = [];

    function getCurrentDatetime() {
      return new Date().toISOString().slice(0, 16);
    }

    function fmtDatetimeLocal(str) {
      let d = new Date(str);
      return d.toLocaleDateString('es-ES', {year: 'numeric', month: 'short', day: '2-digit'}) +
        ' ' + d.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
    }

    function loadHistory() {
      const data = localStorage.getItem(STORAGE_KEY);
      if(data) {
        try { kmHistory = JSON.parse(data); }
        catch { kmHistory = []; }
      } else { kmHistory = []; }
      renderHistory();
    }

    function saveHistory() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(kmHistory));
    }

    function clearForm() {
      kmInput.value = '';
      qtzInput.value = '';
      galInput.value = '';
      fechaInput.value = '';
      imagenInput.value = '';
      editIndex.value = '';
      saveBtn.textContent = 'Registrar / Guardar';
    }

    function renderHistory() {
      historyDiv.innerHTML = '';
      if(kmHistory.length === 0) {
        historyDiv.innerHTML = '<div class="empty">No hay registros aún.</div>';
        return;
      }
      kmHistory
        .map((entry, idx) => ({...entry, idx}))
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))
        .forEach((entry) => {
          const entriesByDate = kmHistory.slice().sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
          const currPos = entriesByDate.findIndex(e => e.fecha === entry.fecha && e.km === entry.km);
          const prev = currPos > 0 ? entriesByDate[currPos-1] : null;
          const diff = prev ? entry.km - prev.km : 0;
          const html = `
            <div class="history-entry">
              <div class="entry-details">
                <div class="date">${fmtDatetimeLocal(entry.fecha)}</div>
                <div class="km">Km: ${Number(entry.km).toLocaleString()}</div>
                <div class="qtz">Gasolina: Q${Number(entry.qtz).toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                <div class="gal">Galones: ${Number(entry.gal).toLocaleString(undefined,{minimumFractionDigits:2})} gal</div>
                <div class="diff">${prev ? `+${diff} km desde anterior` : '---'}</div>
                ${entry.imagen ? `<img src="${entry.imagen}" alt="Imagen del día" style="max-width:100%;margin-top:8px;border-radius:8px;">` : ''}
              </div>
              <div>
                <button class="btn btn-edit" onclick="editEntry(${entry.idx})">Editar</button>
              </div>
            </div>
          `;
          historyDiv.insertAdjacentHTML('beforeend', html);
        });
    }

    form.onsubmit = e => {
      e.preventDefault();
      const km = parseInt(kmInput.value, 10);
      const qtz = parseFloat(qtzInput.value);
      const gal = parseFloat(galInput.value);
      const fecha = fechaInput.value ? new Date(fechaInput.value).toISOString() : new Date().toISOString();

      if(isNaN(km) || isNaN(qtz) || isNaN(gal) || km < 0 || qtz < 0 || gal < 0) {
        alert("Por favor, ingresa datos válidos.");
        return;
      }

      let imagenBase64 = '';
      if (imagenInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imagenBase64 = e.target.result;
          guardarRegistro(km, qtz, gal, fecha, imagenBase64);
        };
        reader.readAsDataURL(imagenInput.files[0]);
      } else {
        guardarRegistro(km, qtz, gal, fecha, '');
      }
    };

    function guardarRegistro(km, qtz, gal, fecha, imagenBase64) {
      let idx = editIndex.value !== '' ? parseInt(editIndex.value,10) : null;
      let isEdit = idx !== null && !isNaN(idx);

      let sortedEntries = kmHistory.slice().sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
      let before = sortedEntries.find(e=>new Date(e.fecha)<new Date(fecha));
      let after = sortedEntries.find(e=>new Date(e.fecha)>new Date(fecha));
      if(before && km < before.km) {
        alert("El kilometraje no puede ser menor que el registro anterior.");
        return;
      }
      if(after && km > after.km) {
        alert("El kilometraje no puede ser mayor que el siguiente registro.");
        return;
      }

      const newEntry = { fecha, km, qtz, gal, imagen: imagenBase64 };

      if(isEdit) {
        kmHistory[idx] = { ...kmHistory[idx], ...newEntry };
      } else {
        kmHistory.push(newEntry);
      }

      saveHistory();
      renderHistory();
      clearForm();
    }

    window.editEntry = function(idx) {
      const entry = kmHistory[idx];
      kmInput.value = entry.km;
      qtzInput.value = entry.qtz;
      galInput.value = entry.gal;
      fechaInput.value = new Date(entry.fecha).toISOString().slice(0, 16);
      editIndex.value = idx;
      saveBtn.textContent = 'Guardar Cambios';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.exportToExcel = function() {
      if(kmHistory.length === 0) {
        alert("No hay datos para exportar.");
        return;
      }
      const sorted = kmHistory.slice().sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
      let data = [["Fecha y hora", "Kilometraje", "Gasolina Q", "Galones", "Km recorridos"]];
      sorted.forEach((e,i)=>{
        let diff = i===0 ? '' : (e.km - sorted[i-1].km);
        data.push([
          fmtDatetimeLocal(e.fecha),
          e.km,
          e.qtz,
          e.gal,
          diff
        ]);
      });
      let ws = XLSX.utils.aoa_to_sheet(data);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Kilometraje");
      XLSX.writeFile(wb, "KilometrajeVehiculo.xlsx");
    }

    function descargarPDF() {
      if(kmHistory.length === 0) {
        alert("No hay datos para exportar.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.addImage('LOGO1.png', 'PNG', 85, 7, 40, 25);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("Control de Kilometraje", 105, 38, { align: "center" });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(13);
      doc.text("Marck Business 2025", 105, 46, { align: "center" });

      const sorted = kmHistory.slice().sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      const body = sorted.map((e, i, arr) => [
        fmtDatetimeLocal(e.fecha),
        e.km,
        "Q" + Number(e.qtz).toLocaleString(undefined, {minimumFractionDigits:2}),
        Number(e.gal).toLocaleString(undefined, {minimumFractionDigits:2}) + " gal",
        i === 0 ? "" : (e.km - arr[i - 1].km)
      ]);

      doc.autoTable({
        startY: 54,
        head: [['Fecha y hora', 'Kilometraje', 'Gasolina (Q)', 'Galones', 'Km recorridos']],
        body: body,
        styles: { fontSize: 11, halign: 'center' },
        headStyles: { fillColor: [0, 200, 150], textColor: 255, fontStyle: 'bold' },
        bodyStyles: { textColor: 30 },
        theme: 'striped',
        margin: { left: 12, right: 12 }
      });

      doc.save("KilometrajeVehiculo.pdf");
    }

    window.descargarPDF = descargarPDF;

    window.resetData = function() {
      let clave = prompt("Para resetear todos los datos, ingrese la clave:");
      if(clave === null) return;
      if(clave === "22782522") {
        if(confirm("¿Está seguro que desea borrar TODOS los datos? Esta acción no se puede deshacer.")) {
          localStorage.removeItem(STORAGE_KEY);
          kmHistory = [];
          renderHistory();
          clearForm();
          alert("¡Todos los datos han sido borrados!");
        }
      } else {
        alert("Clave incorrecta. No se han borrado los datos.");
      }
    }

    clearForm();
    loadHistory();
  </script>
</body>
</html>
